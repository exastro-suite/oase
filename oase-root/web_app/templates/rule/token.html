{% extends "common/page_base_tpl.html" %}
{% comment %}
Copyright 2019 NEC Corporation

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

{% endcomment %}
{% load static %}
{% load common %}
{% load tz %}
{% block myheader %}
<style>
.oase-token {
display: table;
table-layout: fixed;
border-collapse: collapse;
width: calc( 100% - 16px );
margin: 0 auto 24px;
}
.oase-token > div {
display: table-cell
}
.oase-token-data {
padding: 0 16px;
border: 1px solid #CCC;
line-height: 48px;
text-align: center;
letter-spacing: .05em;
font-family: Consolas, "メイリオ", Meiryo, Osaka, "ＭＳ Ｐゴシック", "MS PGothic", "sans-serif";
font-size: 16px;
}
.oase-token-copy {
width: 48px;
border: 1px solid #CCC;
text-align: center;
vertical-align: middle;
font-size: 16px;
cursor: pointer;
}
.oase-token-copy.copy > em {
display: inline-block;
animation: tokenCopy .8s;
}
@keyframes tokenCopy {
  0% { transform: scale( 0.7 ); }
  20% { transform: scale( 1.3 ); }
  40% { transform: scale( 0.85 ); }
  60% { transform: scale( 1.15 ); }
  100% { transform: scale( 1 ); }
}
</style>

<script type="text/javascript">
<!--
////////////////////////////////////////////////
//  未入力エラー処理
////////////////////////////////////////////////
function nonInput(tag, errorTitle, errorMessage){
    tag.parents('th, td').addClass('error');
    var errorHTML = '<ul class="error-list"><li><em class="owf owf-cross"></em>' + errorTitle + '<span class="tooltip help" title="' + errorMessage + '"><em class="owf owf-question"></em></span></li></ul>';
        tag.after( errorHTML );
    if( tag = $("#rule_type_name")){
        tag.addClass("server-error");
    }
}


////////////////////////////////////////////////
//  DB登録（新規登録・複製）
////////////////////////////////////////////////
function submitTokenData(){

    var tokenInfo     = {};
    var objTBody      = document.getElementById("data_object_data");

    // ボタン制御 連打防止
    $("#btnUpd").prop("disabled", true);
    if(confirm(getMessage('MOSJA00002',false)) == false){
        $("#btnUpd").prop("disabled", false);
        return;
    }

    //--------------------------------------------
    // トークン名, 有効期限 の取得
    //--------------------------------------------
    tokenInfo["token_name"]    = $("#token_name").val();
    tokenInfo["user_end_time"] = $("#user_end_time").val();

    //--------------------------------------------
    // アクセス権限の取得
    //--------------------------------------------
    var permissionRecords = [];

    {% for gr in group_list %}
        group_id = '{{gr.group_id}}';
        permission_type_id = $('input[name="token-authority{{gr.group_id}}"]:checked').val();
        if(permission_type_id === undefined)
        {
            permission_type_id = '0';
        }

        var record = {"group_id" : group_id, "permission_type_id" : permission_type_id};
        permissionRecords.push(record)
    {% endfor %}

    tokenInfo["permission"] = permissionRecords;

    //--------------------------------------------
    // エラーチェック
    //--------------------------------------------
    var errorList    = [];
    var errorDict    = {}; //{"エラー表示箇所","エラータイトル", "エラーメッセージ"}

    var noSelect = false;
    $(".conditional-expression").each(function(index, element){
        if($(element).find("option:selected").val() == ""){
            $(element).addClass("non-select");
            noSelect = true;
        }
    });

    if(noSelect){
        errorDict["errorTag"]     = $(".non-select");
        errorDict["errorTitle"]   = getMessage('MOSJA00095', false);
        errorDict["errorMessage"] = getMessage("MOSJA00015", true);
        errorList.push($.extend(true,{},errorDict));
    }

    // エラーがあれば表示
    if (errorList.length != 0){
        alert(getMessage('MOSJA00096', false));
        $.each(errorList, function(index, errorDict){
            nonInput(errorDict["errorTag"], errorDict["errorTitle"], errorDict["errorMessage"]);
        });
        return;
    }

    //--------------------------------------------
    // リクエスト送信
    //--------------------------------------------
    //登録情報をjson形式に変換し、任意のvalueにセットする。
    var jstr = JSON.stringify(tokenInfo["permission"]);
    $("#token-perm").val(jstr);

    $.ajax({
        type : "POST",
        url  : "{% url 'web_app:rule:token_create' %}",
        data : $("#oase-token-data").serialize(),
        dataType : "json",
    })
    .done(function(response_json) {
        if(response_json.status == 'success') {
            confirmOpen('#token-generate');
            $('#tokenGenerate').text(response_json.token);
            beforeunloadThroughFlag = true;
        } else {
            if(response_json.msg) {
                alert(response_json.msg);
            }else{
                alert(getMessage('MOSJA00005', true) + "\n");
            }

            if(response_json.error_msg){
                errorMsg = response_json.error_msg;
                Object.keys(errorMsg).forEach(function(id) {
                    errorStr = errorMsg[id];
                    nonInput($("#"+id), getMessage('MOSJA00097', false), errorMsg[id]);
                });
            }
        }
    })
    .fail(function(respdata, stscode, resp) {
        alert(getMessage("MOSJA00014", true));
        window.location.href = "{% url 'web_app:top:logout' %}";
    });
}

////////////////////////////////////////////////
// 新規追加画面の表示
////////////////////////////////////////////////
function showNewToken(){

    // モーダル画面のタイトル初期化
    $("#modal-title-new").text(getMessage('MOSJA00090', false));
    // 基本情報 初期化
    $("#token_name").val("");
    $("#user_end_time").val("");

    // バリデーションエラー初期化
    $(".error-list").remove();
    $("td").removeClass("error");

    // アクセス権限情報埋め込み
    html = '';
    html += '<table class="authority-table">';
    html += '  <thead>';
    html += '    <tr>';
    html += '      <th><div class="cell-inner">' + getMessage('MOSJA37021', false) + '</div></th>';
    html += '      <th><div class="cell-inner"><em class="owf owf-cross"></em><br>' + getMessage('MOSJA37024', false) + '</div></th>';
    html += '      <th><div class="cell-inner"><em class="owf owf-circle"></em><br>' + getMessage('MOSJA37023', false) + '</div></th>';
    html += '    </tr>';
    html += '  </thead>';
    html += '  <tbody>';
    {% for gr in group_list %}
    grName = '{{gr.group_name}}'
    grId   = '{{gr.group_id}}'
    html += '    <tr>';
    html += '      <th><div id="addGroupNmae' + grId + '" class="cell-inner">' + grName + '</div></th>';
    html += '      <td class="level3">';
    html += '        <div class="cell-inner">';
    html += '          <input value="0" type="radio" name="token-authority' + grId + '" id="token-authority' + grId + '-3a" checked>';
    html += '          <label class="radio" for="token-authority' + grId + '-3a"></label>';
    html += '        </div>';
    html += '      </td>';
    html += '      <td class="level1">';
    html += '        <div class="cell-inner">';
    html += '          <input value="1" type="radio" name="token-authority' + grId + '" id="token-authority' + grId + '-1a">';
    html += '          <label class="radio" for="token-authority' + grId + '-1a"></label>';
    html += '        </div>';
    html += '      </td>';
    html += '    </tr>';
    {% endfor %}
    html += '  </tbody>';
    html += '</table>';
    $("#dlAuthGrpListNew").html(html);

}

////////////////////////////////////////////////
// 権限グループリストの簡易表示を更新する
////////////////////////////////////////////////
$(function(){
  // 条件式選択時 エラー解除
  $(".conditional-expression").change(function(){
    $(".select .error-list").remove();
    $(".select").removeClass("error");
  });

  // 権限グループリスト開閉
  $('.authority-group-list').on('click', 'dt', function(){
    var $clickElement = $( this );
    var $parentBlock = $clickElement.closest('.oase-modal-body');
    var scrollTop = $clickElement.offset().top - $parentBlock.offset().top + $parentBlock.scrollTop() - 8;
    $( this ).next().slideToggle( 0 ,function(){
      // 開いたときスクロールする
      if( $( this ).is(':visible') ) {
        $parentBlock.animate({ scrollTop: scrollTop }, 300 );
      }
    });
  });
  
  // 権限グループリストの簡易表示を変更
  $('.oase-modal').on({
    'click': function(){
      var trIndex = $(this).parents('tbody').find('tr').index( $(this).parents('tr') ) + 1;
      var authorityLevel = $(this).val();
      $(this).parents('dd').prev('dt').find('.authority' + trIndex + ' em').removeClass().addClass('level' + authorityLevel );
    }
  }, 'input[type="radio"]');
});


////////////////////////////////////////////////
// 指定のトークンを削除する
////////////////////////////////////////////////
function deleteToken(btn, url)
{
    //  ボタン非活性
    btn.disabled = true;

    //  確認
    if(confirm(getMessage('MOSJA37018', false)) != true)
    {
        btn.disabled = false;
        return;
    }

    //  削除リクエスト
    $.ajax({
        type : "GET",
        url  : url,
    })
    .done(function(respdata) {
        if(respdata.status == "failure")
        {
            alert(respdata.error_msg);
        }
        else
        {
            alert(getMessage("MOSJA00200", false));
        }

        location.href = respdata.redirect_url;
    })
    .fail(function(respdata, stscode, resp) {
        alert(getMessage("MOSJA00014", true));
        window.location.href = "{% url 'web_app:top:logout' %}";
    });

    //  ボタン活性
    btn.disabled = false;
}


////////////////////////////////////////////////
// 指定のトークンを表示する
////////////////////////////////////////////////
function displayToken(btn)
{
    //  ボタン非活性
    btn.disabled = true;

    //  リクエストパラメーター
    var data = {
        "tkn_id" : $('#viewToken').attr('data-recordid'),
        "passwd" : document.getElementById("tkn_passwd").value,
        "csrfmiddlewaretoken" : document.getElementsByName("csrfmiddlewaretoken")[0].value
    };

    //  トークン表示リクエスト
    $.ajax({
        type     : "POST",
        url      : "{% url 'web_app:rule:token_display' %}",
        data     : data,
    })
    .done(function(respdata) {
        //  ボタン活性
        btn.disabled = false;

        if(respdata.status == "failure")
        {
            alert(respdata.msg);
            beforeunloadThroughFlag = true;
        }
        else
        {
            document.getElementById("tkn_passwd").value = "";
            confirmOpen('#token-redisplay');
            $("#oase-token-data-re-disp").html(respdata.msg);
            beforeunloadThroughFlag = true;
        }
    })
    .fail(function(respdata, stscode, resp) {
        alert(getMessage("MOSJA00014", true));
        window.location.href = "{% url 'web_app:top:logout' %}";
    });
}


////////////////////////////////////////////////
//  詳細画面の表示制御
////////////////////////////////////////////////
function showDetail(token_id){

    {% for token in token_list %}
        if ( token_id == {{token.token_id}} ) {
            $('#viewToken').attr('data-recordid', token_id);
            $('#viewTokenNmae').text("{{token.token_name}}");
            $('#viewUseStartTime').text("{{token.use_start_time|timezone:'Asia/Tokyo'|change_datestyle:request.user.get_lang_mode}}");
            {% if token.use_end_time|length %}
            $('#viewUseEndTime').text("{{token.use_end_time|timezone:'Asia/Tokyo'|change_datestyle:request.user.get_lang_mode}}");
            {% else %}
            $('#viewUseEndTime').text("{{token.use_end_time|timezone:'Asia/Tokyo'}}");
            {% endif %}
            $('#viewTokenLastUpdateUser').text("{{token.last_update_user}}");
            $('#viewTokenLastUpdateTimestamp').text("{{token.last_update_timestamp|timezone:'Asia/Tokyo'|change_datestyle:request.user.get_lang_mode}}");
            $("#hid_tokenid").val(token_id);

            html = '';
            html += '<table class="authority-table">';
            html += '  <thead>';
            html += '    <tr>';
            html += '      <th><div class="cell-inner">' + getMessage('MOSJA37021', false) + '</div></th>';
            html += '      <th><div class="cell-inner">' + getMessage('MOSJA37022', false) + '</div></th>';
            html += '    </tr>';
            html += '  </thead>';
            html += '  <tbody>';
            {% for p in token.permission %}
            grName = '{{p.group_name}}'
            grId   = '{{p.group_id}}'
            html += '    <tr>';
            html += '      <th><div id="viewGroupNmae' + grId + '" class="cell-inner">' + grName + '</div></th>';
            {% if p.permission_type_id == 1 %}
            html += '      <td class="authority-type level1">';
            html += '        <div class="cell-inner"><em class="owf owf-circle"></em>' + getMessage('MOSJA37023', false) + '</div>';
            {% else %}
            html += '      <td class="authority-type level3">';
            html += '        <div class="cell-inner"><em class="owf owf-circle"></em>' + getMessage('MOSJA37024', false) + '</div>';
            {% endif %}
            html += '      </td>';
            html += '    </tr>';
            {% endfor %}
            html += '  </tbody>';
            html += '</table>';
            $("#tokenAuthGrpListView").html(html);
        }
    {% endfor %}
}

////////////////////////////////////////////////
//  トークンの編集画面にデータをセット
////////////////////////////////////////////////
function setInfoInTokenEditView() {

    trId         = $('#viewToken').attr('data-recordid');
    tokenName    = $("#viewTokenNmae").text();
    useStartTime = $("#viewUseStartTime").text();
    useEndTime   = $("#viewUseEndTime").text();

    $('#editTokenNmae').text(tokenName);
    $('#editUseStartTime').text(useStartTime);
    $('#editUseEndTime').text(useEndTime);

    {% for token in token_list %}
    if (trId == {{token.token_id}}){
        html = '';
        html += '<table class="authority-table">';
        html += '  <thead>';
        html += '    <tr>';
        html += '      <th><div class="cell-inner">' + getMessage('MOSJA37021', false) + '</div></th>';
        html += '      <th><div class="cell-inner"><em class="owf owf-cross"></em><br>' + getMessage('MOSJA37024', false) + '</div></th>';
        html += '      <th><div class="cell-inner"><em class="owf owf-circle"></em><br>' + getMessage('MOSJA37023', false) + '</div></th>';
        html += '    </tr>';
        html += '  </thead>';
        html += '  <tbody>';
        {% for p in token.permission %}
        grName = '{{p.group_name}}'
        grId   = '{{p.group_id}}'
        html += '    <tr>';
        html += '      <th><div id="editGroupNmae' + grId + '" class="cell-inner">' + grName + '</div></th>';
        html += '      <td class="level3">';
        html += '        <div class="cell-inner">';
        {% if p.permission_type_id == 0 %}
        html += '          <input value="0" type="radio" name="token-authority' + grId + '" id="token-authority' + grId + '-3b" checked>';
        {% else %}
        html += '          <input value="0" type="radio" name="token-authority' + grId + '" id="token-authority' + grId + '-3b">';
        {% endif %}
        html += '          <label class="radio" for="token-authority' + grId + '-3b"></label>';
        html += '        </div>';
        html += '      </td>';
        html += '      <td class="level1">';
        html += '        <div class="cell-inner">';
        {% if p.permission_type_id == 1 %}
        html += '          <input value="1" type="radio" name="token-authority' + grId + '" id="token-authority' + grId + '-1b" checked>';
        {% else %}
        html += '          <input value="1" type="radio" name="token-authority' + grId + '" id="token-authority' + grId + '-1b">';
        {% endif %}
        html += '          <label class="radio" for="token-authority' + grId + '-1b"></label>';
        html += '        </div>';
        html += '      </td>';
        html += '    </tr>';
        {% endfor %}
        html += '  </tbody>';
        html += '</table>';
        $("#tokenAuthGrpListEdit").html(html);
    }
    {% endfor %}

}

////////////////////////////////////////////////
//  トークン編集画面の更新処理
////////////////////////////////////////////////
function updateToken() {

    var btnId = "#btnUpdToken";
    $(btnId).prop("disabled", true);

    var confirmMsg = getMessage("MOSJA37026", false);
    if(!confirm(confirmMsg)){
        $(btnId).prop("disabled", false);
        return;
    }

    var permissionRecords = [];
    var tokenInfo = {};

    {% for gr in group_list %}
        group_id = '{{gr.group_id}}';
        permission_type_id = $('input[name="token-authority{{gr.group_id}}"]:checked').val();
        var record = {"group_id" : group_id, "permission_type_id" : permission_type_id};
        permissionRecords.push(record)
    {% endfor %}

    tokenInfo["token_id"]   = $('#viewToken').attr('data-recordid')
    tokenInfo["permission"] = permissionRecords;

    var jstr = JSON.stringify({"token_info": tokenInfo});
    $("#upd_record").val(jstr);

    document.getElementById("formTokenData2").submit();
}

function submitAction2(){

    var tokenID = $("#hid_tokenid").val();

    $.ajax({
        type : "POST",
        url  : "token/update/" + tokenID + "/",
        data : $("#formTokenData2").serialize(),
        dataType: "json",
    })
    .done(function(response_json) {
        if(response_json.status == 'success') {
            alert(getMessage('MOSJA00011', false));
            beforeunloadThroughFlag = true;
            $("#btnUpdToken").prop("disabled", false);
            location.href = response_json.redirect_url;
        } else {
            if(response_json.error_msg) {
                alert(response_json.error_msg);
            }else{
                alert(getMessage("MOSJA37027", true));
            }
            $("#btnUpdToken").prop("disabled", false);
        }
    })
    .fail(function(respdata, stscode, resp) {
        if(stscode == "error") {
            alert(getMessage('MOSJA00014', false));
            $("#btnUpdToken").prop("disabled", false);
            window.location.href = "/oase_web/top/logout";
        } else {
            alert(getMessage('MOSJA00014', false) + "\n" + respdata.responseText);
            $("#btnUpdToken").prop("disabled", false);
        }
    });
}
-->
</script>

<script>
$(function(){
  const $modalToken = $('#new-token'),
        $tokenGenerate = $('#token-generate,#token-redisplay');
  
  // カレンダー
  $modalToken.find('.token-end').oaseDatePicker();
  
  // クリップボードにコピー
  if ( navigator.clipboard === undefined && document.execCommand === undefined ) {
    // 未対応の場合はボタンを削除
    $tokenGenerate.find('.oase-token-copy').remove();
  } else {
    $tokenGenerate.find('.oase-token-copy').on('click', function(){

      const $copyButton = $( this );

      // 表示アニメ
      const clickCopy = function(){
        $copyButton.addClass('copy');

        setTimeout( function(){
          $copyButton.removeClass('copy');
        }, 1000 );
      }

      if( !$copyButton.is('.copy') ){
        if ( navigator.clipboard !== undefined ) {
          // navigator.clipboard
          const text = $tokenGenerate.find('.oase-token-data').text();
          navigator.clipboard.writeText(text);
          clickCopy();
        } else if ( document.execCommand !== undefined ) {
          // document.execCommand
          const tokenElm = $tokenGenerate.find('.oase-token-data').get(0),
                range = document.createRange(),
                selection = window.getSelection();
          range.selectNodeContents( tokenElm );
          selection.removeAllRanges();
          selection.addRange( range );
          document.execCommand('copy');
          selection.removeAllRanges();
          clickCopy();
        }    

      }

    });
  }
  
});

</script>

{% endblock %}

{% block maincontent %}
<div class="oase-main">
  <main class="oase-main-inner">

    <div class="oase-main-header">
      <div class="oase-main-header-inner">

        <div class="oase-main-title">
          <div class="oase-main-title-inner">
            <h1>{% get_message 'MOSJA37000' request.user.get_lang_mode showMsgId=False %}</h1>
          </div><!-- /.oase-main-title-inner -->
        </div><!-- /.oase-main-title -->

        <div class="oase-main-menu">
          <div class="oase-main-menu-inner">
            <ul class="oase-button-group">
              {% if hasUpdateAuthority %}
              <li><button class="oase-button" onClick="showNewToken();modalOpen('#new-token');"><em class="owf owf-onetime"></em><span>{% get_message 'MOSJA37001' request.user.get_lang_mode showMsgId=False %}</span></button></li>
              {% endif %}
            </ul>
          </div><!-- /.oase-main-menu-inner -->
        </div><!-- /.oase-main-menu -->

      </div><!-- /.oase-main-header-inner -->
    </div><!-- /.oase-main-header -->

    <div class="oase-main-body full-table">
      <div class="oase-main-body-inner">

      {% if token_list|length %}
        <section>

          <div class="oase-table">

            <div class="oase-table-load loading">
              <div class="oase-table-loader-inner">
                <em class="owf owf-update">
                </em>
              </div>
            </div>

            <div class="oase-table-inner">
              <table class="oase-filter oase-sort">
                <thead>
                  <tr>
                    <th class="operation-menu" filter-label="operation-menu"><div class="cell-inner">{% get_message 'MOSJA37002' request.user.get_lang_mode showMsgId=False %}</div></th>
                    <th class="token-name sort filter" filter-type="common" filter-label="token-name"><div class="cell-inner">{% get_message 'MOSJA37003' request.user.get_lang_mode showMsgId=False %}</div></th>
                    <th class="token-start sort filter" filter-type="date" filter-label="token-start"><div class="cell-inner">{% get_message 'MOSJA37004' request.user.get_lang_mode showMsgId=False %}</div></th>
                    <th class="token-end sort filter" filter-type="date" filter-label="token-end"><div class="cell-inner">{% get_message 'MOSJA37005' request.user.get_lang_mode showMsgId=False %}</div></th>
                    <th class="last-update-user sort filter" filter-type="common" filter-label="last-update-user"><div class="cell-inner">{% get_message 'MOSJA00028' request.user.get_lang_mode showMsgId=False %}</div></th>
                    <th class="last-modified sort filter" filter-type="date" filter-label="last-modified"><div class="cell-inner">{% get_message 'MOSJA00038' request.user.get_lang_mode showMsgId=False %}</div></th>
                  </tr>
                </thead>
                <tbody>
                  {% for token in token_list %}
                  <tr>
                    <td class="operation-menu">
                      <div class="cell-inner">
                        <ul>
                          <li><button class="tooltip detail oase-mini-button" onClick="modalOpen('#token-info');showDetail({{token.token_id}});"><em class="owf owf-details"></em><span>{% get_message 'MOSJA37006' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                          {% if hasUpdateAuthority %}
                          <li><button class="tooltip detail oase-mini-button" onClick="deleteToken(this, '{% url 'web_app:rule:token_delete' token.token_id %}');"><em class="owf owf-trash"></em><span>{% get_message 'MOSJA37007' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                          {% endif %}
                        </ul>
                      </div>
                    </td>
                    <td class="token-name"><div class="cell-inner">{{token.token_name}}</div></td>
                    <td class="token-start"><div class="cell-inner"><time datetime="{{ token.use_start_time|timezone:'Asia/Tokyo'|date:'Y-m-d\TH:i:s' }}">{{ token.use_start_time|timezone:'Asia/Tokyo'|change_datestyle:request.user.get_lang_mode }}</time></div></td>
                    {% if token.use_end_time|length %}
                    <td class="token-end"><div class="cell-inner"><time datetime="{{ token.use_end_time|timezone:'Asia/Tokyo'|date:'Y-m-d\TH:i:s' }}">{{ token.use_end_time|timezone:'Asia/Tokyo'|change_datestyle:request.user.get_lang_mode }}</time></div></td>
                    {% else %}
                    <td class="token-end"><div class="cell-inner"><time datetime="{{ token.use_end_time|timezone:'Asia/Tokyo'|date:'Y-m-d\TH:i:s' }}">{{ token.use_end_time|timezone:'Asia/Tokyo' }}</time></div></td>
                    {% endif %}
                    <td class="last-update-user"><div class="cell-inner">{{token.last_update_user}}</div></td>
                    <td class="last-modified"><div class="cell-inner"><time datetime="{{ token.last_update_timestamp|timezone:'Asia/Tokyo'|date:'Y-m-d\TH:i:s' }}">{{ token.last_update_timestamp|timezone:'Asia/Tokyo'|change_datestyle:request.user.get_lang_mode }}</time></div></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="oase-table-footer">
              <ul class="button-group">
                <li><dl><dt>{% get_message 'MOSJA00022' request.user.get_lang_mode showMsgId=False %}</dt><dd class="rowCount">0</dd></dl></li>
                <li><dl><dt>{% get_message 'MOSJA00023' request.user.get_lang_mode showMsgId=False %}</dt><dd>
                  <select class="rowShowNum">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                  </select>
                </dd></dl></li>
                <li>
                  <button class="pagingPrev button"><em class="owf owf-minus"></em></button>
                  <input class="pagingNow" type="text"> /
                  <span class="pagingMax">0</span>
                  <button class="pagingNext button"><em class="owf owf-plus"></em></button>
                </li>
                <li>
                  <button class="scrollTop button tooltip">
                    <em class="owf owf-up-on"></em><span>{% get_message 'MOSJA00024' request.user.get_lang_mode showMsgId=False %}</span>
                  </button>
                </li>
                <li>
                  <button class="scrollBottom button tooltip">
                    <em class="owf owf-down-on"></em><span>{% get_message 'MOSJA00025' request.user.get_lang_mode showMsgId=False %}</span>
                  </button>
                </li>
              </ul>
            </div>

          </div>

        </section>
      {% else %}
        <div class="oase-none">
          <p>{% autoescape off%}{% get_message 'MOSJA37012' request.user.get_lang_mode showMsgId=False %}{% endautoescape %}</p>
        </div>
      {% endif %}

        <!-- トークン新規 -->
        <div id="new-token" class="oase-modal">

          <div class="oase-modal-main">
            <div class="oase-modal-inner">
              <div class="oase-modal-content">

                <div class="oase-modal-header">
                  <div class="oase-modal-title"><h2><em class="owf owf-onetime"></em><span>{% get_message 'MOSJA37001' request.user.get_lang_mode showMsgId=False %}</span></h2></div>
                  <button class="oase-modal-close" onclick="modalClose('#new-token');"><em class="owf owf-cross"></em></button>
                </div>

                <div class="oase-modal-body">
                  <form id="oase-token-data">
                    <div class="oase-modal-block">
                      <h3>{% get_message 'MOSJA37008' request.user.get_lang_mode showMsgId=False %}</h3>
                      <div class="oase-modal-table">
                        <table>
                          <tbody>

                            <tr>
                              <th><div class="cell-inner">{% get_message 'MOSJA37003' request.user.get_lang_mode showMsgId=False %} <sup>*</sup></div></th>
                              <td>
                                <div class="cell-inner"><input id="token_name" class="validation-input" type="text" placeholder="{% get_message 'MOSJA37003' request.user.get_lang_mode showMsgId=False %}" title="" data-maxlength="64" name="token-name" required></div>
                              </td>
                            </tr>

                            <tr>
                              <th><div class="cell-inner">{% get_message 'MOSJA37009' request.user.get_lang_mode showMsgId=False %}</div></th>
                              <td>
                                <div class="cell-inner"><input type="text" placeholder="{% get_message 'MOSJA37010' request.user.get_lang_mode showMsgId=False %}" class="token-end" name="token-end"></div>
                              </td>
                            </tr>

                          </tbody>
                        </table>
                      </div>
                    </div>

                    <div class="oase-modal-block">

                      <h3>{% get_message 'MOSJA37013' request.user.get_lang_mode showMsgId=False %}</h3>
                      <div id="dlAuthGrpListNew" class="oase-modal-table">
                        <!-- jQueryでここにタグ追加される -->
                      </div>

                    </div>
                    <input id="token-perm" type="hidden" name="token-perm" value=""></input>
                    {% csrf_token %}
                  </form>
                </div>

                <div class="oase-modal-footer">
                  <ul class="oase-button-group">
                    <li><button class="oase-button cancel" onclick="modalClose('#new-token');">
                      <em class="owf owf-cross"></em><span>{% get_message 'MOSJA37011' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                    <li><button class="oase-button clear" onclick="submitTokenData();">
                      <em class="owf owf-onetime"></em><span>{% get_message 'MOSJA37000' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                  </ul>
                </div>

              </div>
            </div>
          </div>

        </div>

        <!-- トークン詳細 -->
        <div id="token-info" class="oase-modal">

          <div class="oase-modal-main">
            <div class="oase-modal-inner">
              <div class="oase-modal-content">

                <div class="oase-modal-header">
                  <div class="oase-modal-title"><h2><em class="owf owf-onetime"></em><span>{% get_message 'MOSJA37019' request.user.get_lang_mode showMsgId=False %}</span></h2></div>
                  <button class="oase-modal-close" onclick="modalClose('#token-info');"><em class="owf owf-cross"></em></button>
                </div>

                <div class="oase-modal-body">
                  <div class="oase-modal-block">
                    <h3>{% get_message 'MOSJA37008' request.user.get_lang_mode showMsgId=False %}</h3>
                    <div class="oase-modal-table">
                      <table>
                        <tbody id="viewToken" data-recordid=''>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37003' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="viewTokenNmae" class="cell-inner"></div></td>
                          </tr>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37004' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="viewUseStartTime" class="cell-inner"></div></td>
                          </tr>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37005' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="viewUseEndTime" class="cell-inner"></div></td>
                          </tr>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA00028' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="viewTokenLastUpdateUser" class="cell-inner"></div></td>
                          </tr>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA00038' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="viewTokenLastUpdateTimestamp" class="cell-inner"></div></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="oase-modal-block">
                    <h3>{% get_message 'MOSJA37013' request.user.get_lang_mode showMsgId=False %}</h3>
                    <div id="tokenAuthGrpListView" class="oase-modal-table">
                      <!-- jQueryでここにタグ追加される -->
                    </div>
                  </div>
                </div>

                <div class="oase-modal-footer">
                  <ul class="oase-button-group">
                    <li><button class="oase-button cancel" onclick="modalClose('#token-info');"><em class="owf owf-cross"></em><span>{% get_message 'MOSJA00070' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                    {% if hasUpdateAuthority %}
                    <li><button class="oase-button edit" onclick="setInfoInTokenEditView(); modalChange('#token-info', '#token-edit');"><em class="owf owf-edit"></em><span>{% get_message 'MOSJA00017' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                    {% endif %}
                    <li><button class="oase-button clear" onclick="modalChange('#token-info','#token-password')"><em class="owf owf-onetime"></em><span>{% get_message 'MOSJA37020' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                  </ul>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- トークン編集 -->
        <div id="token-edit" class="oase-modal">

          <div class="oase-modal-main">
            <div class="oase-modal-inner">
              <div class="oase-modal-content">

                <div class="oase-modal-header">
                  <div class="oase-modal-title"><h2><em class="owf owf-edit"></em><span>{% get_message 'MOSJA37025' request.user.get_lang_mode showMsgId=False %}</span></h2></div>
                  <button class="oase-modal-close" onclick="modalClose('#token-edit');"><em class="owf owf-cross"></em></button>
                </div>

                <div class="oase-modal-body">
                  <div class="oase-modal-block">

                    <div class="oase-modal-table">
                      <table>
                        <tbody>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37003' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="editTokenNmae" class="cell-inner"></div></td>
                          </tr>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37004' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="editUseStartTime" class="cell-inner"></div></td>
                          </tr>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37005' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td><div id="editUseEndTime" class="cell-inner"></div></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="oase-modal-block">
                    <h3>{% get_message 'MOSJA37013' request.user.get_lang_mode showMsgId=False %}</h3>
                    <div id="tokenAuthGrpListEdit" class="oase-modal-table">
                      <!-- jQueryでここにタグ追加される -->
                    </div>
                  </div>
                </div>

                <div class="oase-modal-footer">
                  <ul class="oase-button-group">
                    <li><button class="oase-button cancel" onclick="modalClose('#token-edit', '#btnUpdToken');"><em class="owf owf-cross"></em><span>{% get_message 'MOSJA00018' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                    <li><button class="oase-button" id="btnUpdToken" onclick="updateToken();"><em class="owf owf-edit"></em><span>{% get_message 'MOSJA00021' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                  </ul>
                </div>

                <form id="formTokenData2" action="javascript:submitAction2()" method="POST">
                  {% csrf_token %}
                  <input type="hidden" id="upd_record" value="" name="upd_record" />
                  <input type="hidden" id="hid_tokenid" value="hid_tokenid" />
                </form>

              </div>
            </div>
          </div>
        </div>

        <div id="token-generate" class="oase-confirm">

          <div class="oase-confirm-main">
            <div class="oase-confirm-inner">
              <div class="oase-confirm-content">

                <div class="oase-confirm-header">
                  <div class="oase-confirm-title"><em class="owf owf-onetime"></em> {% get_message 'MOSJA37041' request.user.get_lang_mode showMsgId=False %}</div>
                </div>

                <div class="oase-confirm-body">
                  <p>{% get_message 'MOSJA37042' request.user.get_lang_mode showMsgId=False %}</p>
                  <div class="oase-token">
                    <div id="tokenGenerate" class="oase-token-data"></div>
                    <div class="oase-token-copy tooltip" title="{% get_message 'MOSJA37033' request.user.get_lang_mode showMsgId=False %}"><em class="owf owf-plus"></em></div>
                  </div>
                </div>

                <div class="oase-confirm-footer">
                  <ul class="oase-button-group">
                    <li><button class="oase-button" onClick="confirmClose('#token-generate');modalClose('#new-token');window.location.reload();"><em class="owf owf-cross"></em><span>{% get_message 'MOSJA00070' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                  </ul>
                </div>

              </div>
            </div>
          </div>
        </div>

        {% comment %} トークン再表示のパスワード入力モーダル {% endcomment %}
        <div id="token-password" class="oase-modal">

          <div class="oase-modal-main">
            <div class="oase-modal-inner">
              <div class="oase-modal-content">

                <div class="oase-modal-header">
                  <div class="oase-modal-title"><em class="owf owf-lock"></em> {% get_message 'MOSJA37020' request.user.get_lang_mode showMsgId=False %}</div>
                </div>

                <div class="oase-modal-body">
                  <div class="oase-modal-block">
                    <h3>{% get_message 'MOSJA37030' request.user.get_lang_mode showMsgId=False %}</h3>
                    <div class="oase-modal-table">
                      <table>
                        <tbody>
                          <tr>
                            <th><div class="cell-inner">{% get_message 'MOSJA37031' request.user.get_lang_mode showMsgId=False %}</div></th>
                            <td>
                              <div class="cell-inner">
                                <div class="password"><input id="tkn_passwd" type="password"><div class="password-show"></div></div>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="oase-modal-footer">
                  <ul class="oase-button-group">
                    <li><button class="oase-button" onClick="modalClose('#token-password');"><em class="owf owf-cross"></em><span>{% get_message 'MOSJA00018' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                    <li><button class="oase-button" onClick="displayToken(this);"><em class="owf owf-onetime"></em><span>{% get_message 'MOSJA37020' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                  </ul>
                </div>

              </div>
            </div>
          </div>
        </div>

        {% comment %} トークン再表示 {% endcomment %}
        <div id="token-redisplay" class="oase-confirm">

          <div class="oase-confirm-main">
            <div class="oase-confirm-inner">
              <div class="oase-confirm-content">

                <div class="oase-confirm-header">
                  <div class="oase-confirm-title"><em class="owf owf-onetime"></em> {% get_message 'MOSJA37020' request.user.get_lang_mode showMsgId=False %}</div>
                </div>

                <div class="oase-confirm-body">
                  <p>{% get_message 'MOSJA37032' request.user.get_lang_mode showMsgId=False %}</p>
                  <div class="oase-token">
                    <div id="oase-token-data-re-disp" class="oase-token-data"></div>
                    <div class="oase-token-copy tooltip" title="{% get_message 'MOSJA37033' request.user.get_lang_mode showMsgId=False %}"><em class="owf owf-plus"></em></div>
                  </div>
                </div>

                <div class="oase-confirm-footer">
                  <ul class="oase-button-group">
                    <li><button class="oase-button" onClick="confirmClose('#token-redisplay');modalClose('#token-password')"><em class="owf owf-cross"></em><span>{% get_message 'MOSJA00070' request.user.get_lang_mode showMsgId=False %}</span></button></li>
                  </ul>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="oase-modal-overlay"></div>
        <div class="oase-confirm-overlay"></div>

      </div><!-- /.oase-main-body-inner -->
    </div><!-- /.oase-main-body -->

  </main><!-- /.oase-main-inner -->
</div><!-- /.oase-main -->

{% endblock%}
